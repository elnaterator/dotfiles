#!/bin/bash

# Script to check available IP addresses in an AWS subnet

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

usage() {
    echo "Usage: $0 <subnet-id> [profile] [--list-available]"
    echo ""
    echo "Arguments:"
    echo "  subnet-id          The AWS subnet ID (e.g., subnet-12345678)"
    echo "  profile            Optional AWS profile name (uses default if not specified)"
    echo "  --list-available   List all available IP addresses in the subnet"
    echo ""
    echo "Example:"
    echo "  $0 subnet-12345678"
    echo "  $0 subnet-12345678 my-profile"
    echo "  $0 subnet-12345678 --list-available"
    echo "  $0 subnet-12345678 my-profile --list-available"
    exit 1
}

# Check if subnet ID is provided
if [ -z "$1" ]; then
    usage
fi

SUBNET_ID="$1"
PROFILE_ARG=""
LIST_AVAILABLE=false

# Parse arguments
shift
while [ $# -gt 0 ]; do
    case "$1" in
        --list-available)
            LIST_AVAILABLE=true
            ;;
        *)
            PROFILE_ARG="--profile $1"
            ;;
    esac
    shift
done

echo -e "${BLUE}Checking subnet: ${SUBNET_ID}${NC}"
echo ""

# Get subnet information
SUBNET_INFO=$(aws ec2 describe-subnets \
    --subnet-ids "$SUBNET_ID" \
    $PROFILE_ARG \
    --output json 2>/dev/null)

if [ $? -ne 0 ] || [ -z "$SUBNET_INFO" ]; then
    echo -e "${RED}Error: Could not find subnet ${SUBNET_ID}${NC}"
    exit 1
fi

# Extract subnet details
CIDR_BLOCK=$(echo "$SUBNET_INFO" | jq -r '.Subnets[0].CidrBlock')
AVAILABLE_IPS=$(echo "$SUBNET_INFO" | jq -r '.Subnets[0].AvailableIpAddressCount')
SUBNET_NAME=$(echo "$SUBNET_INFO" | jq -r '.Subnets[0].Tags[]? | select(.Key=="Name") | .Value' 2>/dev/null || echo "N/A")
VPC_ID=$(echo "$SUBNET_INFO" | jq -r '.Subnets[0].VpcId')
AZ=$(echo "$SUBNET_INFO" | jq -r '.Subnets[0].AvailabilityZone')
STATE=$(echo "$SUBNET_INFO" | jq -r '.Subnets[0].State')

# Calculate total IPs from CIDR
# Extract the subnet mask (e.g., /24 from 10.0.1.0/24)
MASK=$(echo "$CIDR_BLOCK" | cut -d'/' -f2)
TOTAL_IPS=$((2 ** (32 - MASK)))

# AWS reserves 5 IPs in each subnet
AWS_RESERVED=5
USABLE_IPS=$((TOTAL_IPS - AWS_RESERVED))
USED_IPS=$((USABLE_IPS - AVAILABLE_IPS))

# Calculate percentage
if [ $USABLE_IPS -gt 0 ]; then
    PERCENT_USED=$((USED_IPS * 100 / USABLE_IPS))
    PERCENT_AVAILABLE=$((AVAILABLE_IPS * 100 / USABLE_IPS))
else
    PERCENT_USED=0
    PERCENT_AVAILABLE=0
fi

# Display results
echo -e "${YELLOW}Subnet Information:${NC}"
echo "  Name:              $SUBNET_NAME"
echo "  Subnet ID:         $SUBNET_ID"
echo "  VPC ID:            $VPC_ID"
echo "  Availability Zone: $AZ"
echo "  CIDR Block:        $CIDR_BLOCK"
echo "  State:             $STATE"
echo ""

echo -e "${YELLOW}IP Address Summary:${NC}"
echo "  Total IPs:         $TOTAL_IPS"
echo "  AWS Reserved:      $AWS_RESERVED (first 4 + last 1)"
echo "  Usable IPs:        $USABLE_IPS"
echo ""

# Color code based on availability
if [ $PERCENT_AVAILABLE -lt 10 ]; then
    COLOR=$RED
elif [ $PERCENT_AVAILABLE -lt 30 ]; then
    COLOR=$YELLOW
else
    COLOR=$GREEN
fi

echo -e "${YELLOW}Current Usage:${NC}"
echo -e "  Used:              ${RED}${USED_IPS}${NC} ($PERCENT_USED%)"
echo -e "  Available:         ${COLOR}${AVAILABLE_IPS}${NC} ($PERCENT_AVAILABLE%)"
echo ""

# Warning if low on IPs
if [ $PERCENT_AVAILABLE -lt 10 ]; then
    echo -e "${RED}⚠ WARNING: Less than 10% of IP addresses available!${NC}"
elif [ $PERCENT_AVAILABLE -lt 30 ]; then
    echo -e "${YELLOW}⚠ CAUTION: Less than 30% of IP addresses available${NC}"
else
    echo -e "${GREEN}✓ Healthy IP address availability${NC}"
fi

# List available IPs if requested
if [ "$LIST_AVAILABLE" = true ]; then
    echo ""
    echo -e "${BLUE}Fetching network interfaces...${NC}"
    
    # Get all network interfaces in the subnet
    ENIS=$(aws ec2 describe-network-interfaces \
        --filters "Name=subnet-id,Values=$SUBNET_ID" \
        $PROFILE_ARG \
        --output json 2>/dev/null)
    
    # Extract all used private IPs
    USED_IP_LIST=$(echo "$ENIS" | jq -r '.NetworkInterfaces[].PrivateIpAddresses[].PrivateIpAddress' | sort -V)
    
    # Function to convert IP to integer
    ip_to_int() {
        local ip=$1
        local a b c d
        IFS=. read -r a b c d <<< "$ip"
        echo $((a * 256 ** 3 + b * 256 ** 2 + c * 256 + d))
    }
    
    # Function to convert integer to IP
    int_to_ip() {
        local int=$1
        echo "$((int >> 24 & 255)).$((int >> 16 & 255)).$((int >> 8 & 255)).$((int & 255))"
    }
    
    # Get base IP and calculate range
    BASE_IP=$(echo "$CIDR_BLOCK" | cut -d'/' -f1)
    BASE_INT=$(ip_to_int "$BASE_IP")
    
    # Calculate first and last usable IPs (skip AWS reserved)
    FIRST_USABLE=$((BASE_INT + 5))  # Skip .0, .1, .2, .3, .4
    LAST_USABLE=$((BASE_INT + TOTAL_IPS - 2))  # Skip last IP
    
    echo ""
    echo -e "${YELLOW}Available IP Addresses:${NC}"
    echo -e "${GREEN}"
    
    AVAILABLE_COUNT=0
    
    # Iterate through all possible IPs in range
    for ((i=FIRST_USABLE; i<=LAST_USABLE; i++)); do
        IP=$(int_to_ip $i)
        # Check if IP is not in used list (using grep)
        if ! echo "$USED_IP_LIST" | grep -q "^${IP}$"; then
            echo "  $IP"
            AVAILABLE_COUNT=$((AVAILABLE_COUNT + 1))
        fi
    done
    
    echo -e "${NC}"
    echo "Total available IPs listed: $AVAILABLE_COUNT"
    
    if [ $AVAILABLE_COUNT -ne $AVAILABLE_IPS ]; then
        echo -e "${YELLOW}Note: AWS reports $AVAILABLE_IPS available IPs (difference may be due to reserved IPs)${NC}"
    fi
fi
